name: Update IPTV

on:
  schedule:
    - cron: '0 1 * * *'  # æ¯æ—¥è‡ªå‹•æ›´æ–°ï¼ˆUTC+8 æ—©ä¸Š 9:00ï¼‰
  workflow_dispatch:

env:
  TZ: Asia/Shanghai

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
    #--------------------------------------------------
    # ğŸ§¹ æ¸…ç†ç£ç¢Ÿç©ºé–“ï¼Œé¿å… "No space left on device"
    #--------------------------------------------------
    - name: Free disk space
      run: |
        echo "ğŸ’¾ æ¸…ç†ç£ç¢Ÿç©ºé–“..."
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc || true
        sudo apt-get clean
        df -h

    #--------------------------------------------------
    # ğŸ“¦ å–å‡ºç¨‹å¼ç¢¼
    #--------------------------------------------------
    - name: Checkout repository
      uses: actions/checkout@v4

    #--------------------------------------------------
    # ğŸ•’ å–å¾—æ™‚é–“
    #--------------------------------------------------
    - name: Get current date
      id: date
      run: echo "date=$(date '+%Y-%m-%d %H:%M:%S CST')" >> "$GITHUB_OUTPUT"

    #--------------------------------------------------
    # ğŸ”„ æ›´æ–° IPTV æº
    #--------------------------------------------------
    - name: Update IPTV sources
      shell: bash
      run: |
        set -euo pipefail
        echo "=== ğŸš€ é–‹å§‹æ›´æ–° IPTV æº ==="

        #--------------------------------------------------
        # ğŸ§© é€šç”¨å‡½æ•¸
        #--------------------------------------------------
        download() {
          local url="$1" file="$2"
          echo "â†“ ä¸‹è¼‰: $url"
          for i in {1..3}; do
            if wget -q --timeout=30 --max-filesize=10m "$url" -O "$file"; then
              return 0
            fi
            echo "âš ï¸ ç¬¬ $i æ¬¡ä¸‹è¼‰å¤±æ•—ï¼Œé‡è©¦ä¸­..."
            sleep 3
          done
          echo "âŒ ç„¡æ³•ä¸‹è¼‰: $url"
          return 1
        }

        clean_m3u() {
          local file="$1"
          [[ -f "$file" ]] || return
          sed -i '/^\s*$/d' "$file"
          sed -i '1s/^/#EXTM3U\n/' "$file"
        }

        combine_m3u() {
          local output="$1"; shift
          echo "#EXTM3U" > "$output"
          for f in "$@"; do
            [[ -f "$f" ]] && tail -n +2 "$f" >> "$output"
          done
          sed -i '/^\s*$/d' "$output"
        }

        validate_m3u() {
          local file="$1"
          [[ -f "$file" ]] || return
          local info_count url_count
          info_count=$(grep -c '^#EXTINF' "$file" || true)
          url_count=$(grep -Ec '^(http|rtsp)' "$file" || true)
          if (( info_count < 1 || url_count < 1 )); then
            echo "âš ï¸ é©—è­‰å¤±æ•—ï¼š$fileï¼ˆEXTINF:$info_count / URL:$url_countï¼‰ â†’ å·²åˆªé™¤"
            rm -f "$file"
          else
            echo "âœ… é©—è­‰é€šéï¼š$fileï¼ˆEXTINF:$info_count / URL:$url_countï¼‰"
          fi
        }

        validate_all() {
          for f in *.m3u; do
            validate_m3u "$f"
          done
        }

        #--------------------------------------------------
        # ğŸ“º å¤®è§†èˆ‡å«è§†æº
        #--------------------------------------------------
        download "https://raw.githubusercontent.com/fanmingming/live/main/tv/m3u/ipv6.m3u" source.m3u || true
        sed -n '/å¤®è§†é¢‘é“/,+1p' source.m3u > CCTV.m3u || true
        sed -n '/å«è§†é¢‘é“/,+1p' source.m3u > CNTV1.m3u || true
        sed -n '/NewTVç³»åˆ—/,+1p' source.m3u > CNTV2.m3u || true
        sed -n '/è¶…æ¸…é¢‘é“/,+1p' source.m3u > CNTV3.m3u || true
        combine_m3u CNTV.m3u CNTV1.m3u CNTV2.m3u CNTV3.m3u
        clean_m3u CCTV.m3u
        rm -f CNTV1.m3u CNTV2.m3u CNTV3.m3u source.m3u

        #--------------------------------------------------
        # ğŸ” æˆäººæºï¼ˆå¦‚ä¸éœ€å¯è¨»è§£ï¼‰
        #--------------------------------------------------
        for src in \
          "http://adultiptv.net/chs.m3u" \
          "https://met.pages.dev/static/iptv/av.m3u" \
          "https://raw.githubusercontent.com/hfpiao/IPTV/refs/heads/main/Adult.m3u" \
          "https://raw.githubusercontent.com/yyqyu/mytv/refs/heads/main/Adult.m3u" \
          "https://raw.githubusercontent.com/WaykeYu/MyTV_tw/refs/heads/main/UBTV18.m3u"
        do
          fname="$(basename "$src" | sed 's/\.m3u//')"
          download "$src" "${fname}.m3u" || true
        done
        combine_m3u Adult.m3u *.m3u
        sed -i 's/XXX/æˆäººé¢‘é“/g; s/AdultIPTV.net //g' Adult.m3u || true

        #--------------------------------------------------
        # ğŸ‡­ğŸ‡°ğŸ‡²ğŸ‡´ğŸ‡¹ğŸ‡¼ æ¸¯æ¾³å°æº
        #--------------------------------------------------
        urls=(
          "https://raw.githubusercontent.com/Mitchll1214/m3u/main/æ¸¯æ¾³å°.m3u"
          "https://cdn.jsdelivr.net/gh/Guovin/iptv-api@gd/output/result.m3u"
          "https://ghp.ci/https://raw.githubusercontent.com/yuanzl77/IPTV/main/live.m3u"
          "https://epg.pw/test_channels_taiwan.m3u"
          "https://iptv-org.github.io/iptv/countries/tw.m3u"
          "https://raw.githubusercontent.com/WaykeYu/MyTV_tw/refs/heads/main/TW_switch.m3u"
          "https://raw.githubusercontent.com/WaykeYu/verify-iptv/refs/heads/main/source/UBTV.m3u"
        )
        for url in "${urls[@]}"; do
          download "$url" "$(basename "$url")" || true
        done
        combine_m3u GAT.m3u *.m3u
        rm -f æ¸¯æ¾³å°.m3u result.m3u live.m3u test_channels_taiwan.m3u tw.m3u TW_switch.m3u UBTV.m3u

        #--------------------------------------------------
        # ğŸ’ 4K æº
        #--------------------------------------------------
        download "https://raw.githubusercontent.com/YanG-1989/m3u/main/Gather.m3u" 4k_raw.m3u || true
        grep -iA1 "4K" 4k_raw.m3u > 4k.m3u || true
        clean_m3u 4k.m3u
        rm -f 4k_raw.m3u

        #--------------------------------------------------
        # ğŸ§ª é©—è­‰èˆ‡æ•´åˆ
        #--------------------------------------------------
        validate_all
        combine_m3u IPTV.m3u CCTV.m3u CNTV.m3u GAT.m3u 4k.m3u
        combine_m3u IPTV-all.m3u CCTV.m3u CNTV.m3u GAT.m3u 4k.m3u Adult.m3u

        #--------------------------------------------------
        # ğŸ“„ ç¯€ç›®è¡¨èˆ‡ README
        #--------------------------------------------------
        download "https://epg.112114.xyz/pp.xml" EPG.xml || true
        {
          echo "### ğŸ“º IPTV è‡ªå‹•æ›´æ–°"
          echo "- æ›´æ–°æ™‚é–“ï¼š${{ steps.date.outputs.date }}"
          echo "- è‡ªå‹•ç”Ÿæˆä¾†æºï¼šhttps://github.com/${{ github.repository }}"
        } > README.md

    #--------------------------------------------------
    # ğŸ’¾ æäº¤æ›´æ–°
    #--------------------------------------------------
    - name: Commit and push changes
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git add .
        git commit -m "ğŸ”„ Update IPTV sources: ${{ steps.date.outputs.date }}" || echo "No changes to commit"
        git push

    #--------------------------------------------------
    # ğŸ§½ æœ€å¾Œæ¸…ç†ï¼Œé‡‹æ”¾ç©ºé–“
    #--------------------------------------------------
    - name: Clean workspace
      if: always()
      run: |
        echo "ğŸ§¹ æ¸…ç†æš«å­˜èˆ‡ä¸‹è¼‰æª”æ¡ˆ..."
        sudo rm -rf /home/runner/work/_temp/*
        sudo rm -rf /home/runner/work/${{ github.repository }}/*
        df -h
