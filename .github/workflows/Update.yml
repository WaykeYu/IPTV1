name: Update IPTV

on:
  schedule:
    - cron: '0 1 * * *'
  workflow_dispatch:

env:
  TZ: Asia/Shanghai

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.19'

      - name: Get current date
        id: date
        run: echo "date=$(date +'%Y-%m-%d %H:%M:%S CST')" >> $GITHUB_OUTPUT

      - name: Update IPTV sources
        shell: bash
        run: |
          set -eo pipefail
          echo "=== ðŸš€ é–‹å§‹æ›´æ–° IPTV æº ==="

          DATE="${{ steps.date.outputs.date }}"

          download() {
            local url=$1
            local file=$2
            echo "â†“ ä¸‹è¼‰: $url"
            if wget -q --timeout=30 -O "$file" "$url"; then
              echo "âœ… æˆåŠŸï¼š$url"
            else
              echo "âš ï¸ ä¸‹è¼‰å¤±æ•—: $url"
              rm -f "$file"
            fi
          }

          clean_m3u() {
            local file=$1
            [ -f "$file" ] || return
            sed -i '/^\s*$/d' "$file"
            grep -q '^#EXTM3U' "$file" || sed -i '1i #EXTM3U' "$file"
          }

          combine_m3u() {
            local output=$1
            shift
            echo "#EXTM3U" > "$output"
            for f in "$@"; do
              [ -f "$f" ] && cat "$f" >> "$output"
            done
            sed -i '/^\s*$/d' "$output"
          }

          validate_m3u() {
            local file=$1
            [ -f "$file" ] || return
            local info_count=$(grep -c '^#EXTINF' "$file" || true)
            local url_count=$(grep -Ec '^(http|rtsp)' "$file" || true)
            if [ "$info_count" -lt 3 ] || [ "$url_count" -lt 3 ]; then
              echo "âš ï¸ é©—è­‰å¤±æ•—ï¼š$fileï¼ˆEXTINF:$info_count / URL:$url_countï¼‰ â†’ å·²åˆªé™¤"
              rm -f "$file"
            else
              echo "âœ… é©—è­‰é€šéŽï¼š$fileï¼ˆEXTINF:$info_count / URL:$url_countï¼‰"
            fi
          }

          validate_all() {
            for f in *.m3u; do
              validate_m3u "$f"
            done
          }

          # ---------------------------
          # å¤®è§†æº
          # ---------------------------
          download "https://raw.githubusercontent.com/fanmingming/live/main/tv/m3u/ipv6.m3u" source.m3u
          if grep -q 'å¤®è§†é¢‘é“' source.m3u; then
            sed -n '/å¤®è§†é¢‘é“/,+1p' source.m3u > CCTV.m3u
            clean_m3u CCTV.m3u
          fi

          # ---------------------------
          # å«è§†æº
          # ---------------------------
          tmp1=$(mktemp /tmp/tmpfile.XXXXXX)
          tmp2=$(mktemp /tmp/tmpfile.XXXXXX)
          tmp3=$(mktemp /tmp/tmpfile.XXXXXX)
          sed -n '/å«è§†é¢‘é“/,+1p' source.m3u > "$tmp1" || true
          sed -n '/NewTVç³»åˆ—/,+1p' source.m3u > "$tmp2" || true
          sed -n '/è¶…æ¸…é¢‘é“/,+1p' source.m3u > "$tmp3" || true
          combine_m3u CNTV.m3u "$tmp1" "$tmp2" "$tmp3"
          rm -f "$tmp1" "$tmp2" "$tmp3"

          # ---------------------------
          # æˆäººæº
          # ---------------------------
          download "http://adultiptv.net/chs.m3u" AdultA.m3u
          sed -i 's/XXX/æˆäººé¢‘é“/' AdultA.m3u || true
          sed -i 's/AdultIPTV.net //g' AdultA.m3u || true
          download "https://met.pages.dev/static/iptv/av.m3u" AdultB.m3u
          download "https://raw.githubusercontent.com/hfpiao/IPTV/refs/heads/main/Adult.m3u" AdultC.m3u
          download "https://raw.githubusercontent.com/yyqyu/mytv/refs/heads/main/Adult.m3u" AdultD.m3u
          download "https://raw.githubusercontent.com/WaykeYu/MyTV_tw/refs/heads/main/UBTV18.m3u" AdultE.m3u
          combine_m3u Adult.m3u AdultA.m3u AdultB.m3u AdultC.m3u AdultD.m3u AdultE.m3u
          rm -f AdultA.m3u AdultB.m3u AdultC.m3u AdultD.m3u AdultE.m3u

          # ---------------------------
          # æ¸¯æ¾³å°æº
          # ---------------------------
          download "https://raw.githubusercontent.com/Mitchll1214/m3u/main/æ¸¯æ¾³å°.m3u" GAT1.m3u
          download "https://cdn.jsdelivr.net/gh/Guovin/iptv-api@gd/output/result.m3u" GAT2.m3u
          download "https://ghp.ci/https://raw.githubusercontent.com/yuanzl77/IPTV/main/live.m3u" GAT3.m3u
          download "https://epg.pw/test_channels_taiwan.m3u" GAT4.m3u
          download "https://iptv-org.github.io/iptv/countries/tw.m3u" GAT5.m3u
          download "https://raw.githubusercontent.com/WaykeYu/MyTV_tw/refs/heads/main/TW_switch.m3u" GAT6.m3u
          download "https://raw.githubusercontent.com/WaykeYu/verify-iptv/refs/heads/main/source/UBTV.m3u" GAT7.m3u
          combine_m3u GAT.m3u GAT1.m3u GAT2.m3u GAT3.m3u GAT4.m3u GAT5.m3u GAT6.m3u GAT7.m3u
          rm -f GAT1.m3u GAT2.m3u GAT3.m3u GAT4.m3u GAT5.m3u GAT6.m3u GAT7.m3u

          # ---------------------------
          # 4K æºï¼ˆæ”¹åç‚º fourk_*ï¼‰
          # ---------------------------
          download "https://raw.githubusercontent.com/YanG-1989/m3u/main/Gather.m3u" fourk_raw.m3u
          sed -n '/4K/,+1p' fourk_raw.m3u > fourk.m3u || true
          sed -n '/4k/,+1p' fourk_raw.m3u >> fourk.m3u || true
          clean_m3u fourk.m3u
          rm -f fourk_raw.m3u

          # ---------------------------
          # é©—è­‰æ‰€æœ‰ m3u
          # ---------------------------
          echo "=== ðŸ” é–‹å§‹é©—è­‰æ‰€æœ‰ m3u æª”æ¡ˆ ==="
          validate_all

          # ---------------------------
          # æ•´åˆæº
          # ---------------------------
          combine_m3u IPTV.m3u CCTV.m3u CNTV.m3u GAT.m3u fourk.m3u
          combine_m3u IPTV-all.m3u CCTV.m3u CNTV.m3u GAT.m3u fourk.m3u Adult.m3u

          # ---------------------------
          # ä¸‹è¼‰ EPG
          # ---------------------------
          download "https://epg.112114.xyz/pp.xml" EPG.xml

          # å¯« README
          cat > README.md <<'EOF'
### ðŸ“º IPTV è‡ªå‹•æ›´æ–°
- æ›´æ–°æ™‚é–“: '"$DATE"'
- å·²é©—è­‰å„ M3U æª”æ¡ˆæœ‰æ•ˆæ€§
- ä¾†æº: fanmingming, YanG-1989, WaykeYu, Guovin, adultiptv ç­‰
- è‡ªå‹•æ•´åˆç”Ÿæˆ IPTV.m3u èˆ‡ IPTV-all.m3u
EOF

          echo "=== âœ… æ›´æ–°èˆ‡é©—è­‰å®Œæˆ ==="

      - name: Commit and Push changes
        shell: bash
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add -A
          if ! git diff --quiet; then
            git commit -am "ðŸ“… Update: ${{ steps.date.outputs.date }}"
            git push -f origin HEAD:${{ github.ref_name }}
          else
            echo "ðŸŸ¢ No changes to commit."
