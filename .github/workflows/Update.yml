name: Update IPTV

on:
  schedule:
    - cron: '0 1 * * *'
  workflow_dispatch:

env:
  TZ: Asia/Shanghai

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.19'

    - name: Get current date
      id: date
      run: echo "date=$(date +'%Y-%m-%d %H:%M:%S CST')" >> $GITHUB_OUTPUT

    - name: Update IPTV sources
      run: |
        set -e
        echo "=== ğŸš€ é–‹å§‹æ›´æ–° IPTV æº ==="
        #--------------------------------------------------
        # ğŸ§© é€šç”¨å‡½æ•¸
        #--------------------------------------------------
        download() {
          url=$1
          file=$2
          echo "â†“ ä¸‹è¼‰: $url"
          wget -q --timeout=30 "$url" -O "$file" || echo "âš ï¸ ä¸‹è¼‰å¤±æ•—: $url"
        }
        clean_m3u() {
          file=$1
          [ -f "$file" ] && sed -i '/^\s*$/d' "$file"
          [ -f "$file" ] && sed -i '1i #EXTM3U' "$file"
        }
        combine_m3u() {
          output=$1
          shift
          echo "#EXTM3U" > "$output"
          for f in "$@"; do
            [ -f "$f" ] && cat "$f" >> "$output"
          done
          sed -i '/^\s*$/d' "$output"
        }
        validate_m3u() {
          file=$1
          if [ -f "$file" ]; then
            info_count=$(grep -c '^#EXTINF' "$file" || true)
            url_count=$(grep -Ec '^(http|rtsp)' "$file" || true)
            if [ "$info_count" -lt 1 ] || [ "$url_count" -lt 1 ]; then
              echo "âš ï¸ é©—è­‰å¤±æ•—ï¼š$fileï¼ˆEXTINF:$info_count / URL:$url_countï¼‰ â†’ å·²åˆªé™¤"
              rm -f "$file"
            else
              echo "âœ… é©—è­‰é€šéï¼š$fileï¼ˆEXTINF:$info_count / URL:$url_countï¼‰"
            fi
          fi
        }
        validate_all() {
          for f in *.m3u; do
            validate_m3u "$f"
          done
        }
        #--------------------------------------------------
        # ğŸ“º å¤®è§†æº
        #--------------------------------------------------
        download "https://raw.githubusercontent.com/fanmingming/live/main/tv/m3u/ipv6.m3u" source.m3u
        sed -n '/å¤®è§†é¢‘é“/,+1p' source.m3u > CCTV.m3u
        clean_m3u CCTV.m3u
        #--------------------------------------------------
        # ğŸ›°ï¸ å«è§†æº
        #--------------------------------------------------
        sed -n '/å«è§†é¢‘é“/,+1p' source.m3u > CNTV1.m3u
        sed -n '/NewTVç³»åˆ—/,+1p' source.m3u > CNTV2.m3u
        sed -n '/è¶…æ¸…é¢‘é“/,+1p' source.m3u > CNTV3.m3u
        combine_m3u CNTV.m3u CNTV1.m3u CNTV2.m3u CNTV3.m3u
        rm -f CNTV1.m3u CNTV2.m3u CNTV3.m3u
        #--------------------------------------------------
        # ğŸ” æˆäººæº
        #--------------------------------------------------
        download "http://adultiptv.net/chs.m3u" AdultA.m3u
        sed -i 's/XXX/æˆäººé¢‘é“/' AdultA.m3u
        sed -i 's/AdultIPTV.net //g' AdultA.m3u
        download "https://met.pages.dev/static/iptv/av.m3u" AdultB.m3u
        download "https://raw.githubusercontent.com/hfpiao/IPTV/refs/heads/main/Adult.m3u" AdultC.m3u
        download "https://raw.githubusercontent.com/yyqyu/mytv/refs/heads/main/Adult.m3u" AdultD.m3u
        download "https://raw.githubusercontent.com/WaykeYu/MyTV_tw/refs/heads/main/UBTV18.m3u" AdultE.m3u
        download "https://raw.githubusercontent.com/WaykeYu/verify-iptv/refs/heads/main/source/XstR.m3u" AdultF.m3u
        download "https://raw.githubusercontent.com/WaykeYu/verify-iptv/refs/heads/main/source/%E5%9B%BD%E5%8C%BA%E8%80%81%E4%BC%A0%E5%AA%92.m3u" AdultG.m3u
        download "https://raw.githubusercontent.com/WaykeYu/verify-iptv/refs/heads/main/source/%E6%9C%80%E5%A5%BD%E7%9A%8418%2B.m3u" AdultH.m3u
        combine_m3u Adult.m3u AdultA.m3u AdultB.m3u AdultC.m3u AdultD.m3u AdultE.m3u AdultF.m3u AdultG.m3u AdultH.m3u
        rm -f AdultA.m3u AdultB.m3u AdultC.m3u AdultD.m3u AdultE.m3u AdultF.m3u AdultG.m3u AdultH.m3u
        #--------------------------------------------------
        # ğŸ‡­ğŸ‡°ğŸ‡²ğŸ‡´ğŸ‡¹ğŸ‡¼ æ¸¯æ¾³å°æº
        #--------------------------------------------------
        download "https://raw.githubusercontent.com/Mitchll1214/m3u/main/æ¸¯æ¾³å°.m3u" GAT1.m3u
        download "https://cdn.jsdelivr.net/gh/Guovin/iptv-api@gd/output/result.m3u" GAT2.m3u
        download "https://ghp.ci/https://raw.githubusercontent.com/yuanzl77/IPTV/main/live.m3u" GAT3.m3u
        download "https://epg.pw/test_channels_taiwan.m3u" GAT4.m3u
        download "https://iptv-org.github.io/iptv/countries/tw.m3u" GAT5.m3u
        download "https://raw.githubusercontent.com/WaykeYu/MyTV_tw/refs/heads/main/TW_switch.m3u" GAT6.m3u
        download "https://raw.githubusercontent.com/WaykeYu/verify-iptv/refs/heads/main/source/UBTV.m3u" GAT7.m3u
        download "https://raw.githubusercontent.com/WaykeYu/verify-iptv/refs/heads/main/source/me.m3u" GAT8.m3u
        combine_m3u GAT.m3u GAT1.m3u GAT2.m3u GAT3.m3u GAT4.m3u GAT5.m3u GAT6.m3u GAT7.m3u GAT8.m3u
        rm -f GAT1.m3u GAT2.m3u GAT3.m3u GAT4.m3u GAT5.m3u GAT6.m3u GAT7.m3u GAT8.m3u 
        #--------------------------------------------------
        # ğŸ’ 4K æº
        #--------------------------------------------------
        download "https://raw.githubusercontent.com/YanG-1989/m3u/main/Gather.m3u" 4k_raw.m3u
        sed -n '/4K/,+1p' 4k_raw.m3u > 4k.m3u
        sed -n '/4k/,+1p' 4k_raw.m3u >> 4k.m3u
        clean_m3u 4k.m3u
        rm -f 4k_raw.m3u
        #--------------------------------------------------
        # ğŸ§ª é©—è­‰å„æºæª”æ¡ˆæœ‰æ•ˆæ€§
        #--------------------------------------------------
        echo "=== ğŸ” é–‹å§‹é©—è­‰æ‰€æœ‰ m3u æª”æ¡ˆ ==="
        validate_all
        #--------------------------------------------------
        # ğŸ”— æ•´åˆæºï¼ˆç„¡æˆäººï¼‰
        #--------------------------------------------------
        combine_m3u IPTV.m3u CCTV.m3u CNTV.m3u GAT.m3u 4k.m3u
        #--------------------------------------------------
        # ğŸ”— æ•´åˆæºï¼ˆå«æˆäººï¼‰
        #--------------------------------------------------
        combine_m3u IPTV-all.m3u CCTV.m3u CNTV.m3u GAT.m3u 4k.m3u Adult.m3u
        #--------------------------------------------------
        # ğŸ—“ï¸ ç¯€ç›®æºèˆ‡èªªæ˜æ–‡ä»¶
        #--------------------------------------------------
        download "https://epg.112114.xyz/pp.xml" EPG.xml
        echo "### ğŸ“º IPTV è‡ªå‹•æ›´æ–°" > README.md
        echo "- æ›´æ–°æ™‚é–“ï¼š${{ steps.date.outputs.date }}" >> README.md
        echo "- å·²é©—è­‰å„ M3U æª”æ¡ˆæœ‰æ•ˆæ€§" >> README.md
        echo "- ä¾†æºï¼šfanmingmingã€YanG-1989ã€WaykeYuã€Guovinã€adultiptv ç­‰" >> README.md
        echo "- è‡ªå‹•æ•´åˆç”Ÿæˆ IPTV.m3u èˆ‡ IPTV-all.m3u" >> README.md
        echo "=== âœ… æ›´æ–°èˆ‡é©—è­‰å®Œæˆ ==="
    - name: Commit and Push
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add -A
        git diff --quiet && echo "No changes to commit." || git commit -am "${{ steps.date.outputs.date }}"
        git push -f origin main
